<div class="card mb-3" *ngIf="post">
  <div class="card-body">
    <div class="d-flex align-items-center mb-3">
      <img [src]="post.author.profilePicture || 'https://via.placeholder.com/40'" 
           class="rounded-circle me-3" 
           alt="Avatar"
           style="width: 40px; height: 40px; object-fit: cover;">
      <div>
        <h6 class="mb-0">{{post.author.username}}</h6>
        <small class="text-muted">{{post.createdDate | date:'short'}}</small>
      </div>
    </div>
    
    <p class="card-text" [innerHTML]="formatContent(post.content)"></p>
    
    <!-- Media Display -->
    <div class="mb-3" *ngIf="post.imageUrl">
      <!-- Video Display -->
      <video 
        *ngIf="isVideo(post.mediaType)" 
        [src]="post.imageUrl" 
        class="img-fluid rounded" 
        style="max-width: 100%; max-height: 400px;"
        controls
        preload="metadata">
        Your browser does not support the video tag.
      </video>
      
      <!-- Image Display -->
      <img 
        *ngIf="isImage(post.mediaType)" 
        [src]="post.imageUrl" 
        class="img-fluid rounded" 
        style="max-width: 100%; max-height: 400px; object-fit: cover;"
        alt="Post media">
    </div>
    
    <div class="d-flex gap-3">
      <button class="btn btn-sm btn-outline-primary">
        <i class="fas fa-heart"></i> Like ({{post.likesCount}})
      </button>
      <button class="btn btn-sm btn-outline-secondary" (click)="toggleComments()">
        <i class="fas fa-comment"></i> Comment ({{post.commentsCount}})
      </button>
      <button class="btn btn-sm btn-outline-info">
        <i class="fas fa-share"></i> Share ({{post.sharesCount}})
      </button>
    </div>
    
    <!-- Comments Section -->
    <div *ngIf="showComments" class="mt-3 border-top pt-3">
      <!-- Add Comment Form -->
      <div class="mb-3">
        <div class="position-relative">
          <textarea 
            #commentTextarea
            class="form-control" 
            rows="2" 
            placeholder="Write a comment... Use @username to mention"
            [(ngModel)]="newComment"
            (keyup)="onCommentKeyUp($event)"
            (keydown)="onCommentKeyDown($event)"></textarea>
          
          <!-- User suggestions dropdown for comments -->
          <div *ngIf="showCommentSuggestions && commentSuggestions.length > 0" 
               class="position-absolute bg-white border rounded shadow-sm" 
               style="top: 100%; left: 0; right: 0; z-index: 1000; max-height: 150px; overflow-y: auto;">
            <div *ngFor="let user of commentSuggestions; let i = index" 
                 class="p-2 border-bottom cursor-pointer hover-bg-light"
                 [class.bg-light]="selectedCommentSuggestionIndex === i"
                 (click)="selectCommentUser(user)">
              <strong>@{{user.username}}</strong>
            </div>
          </div>
        </div>
        
        <button class="btn btn-primary btn-sm mt-2" 
                (click)="addComment()" 
                [disabled]="!newComment.trim()">
          Post Comment
        </button>
      </div>
      
      <!-- Comments List -->
      <div class="comments-list">
        <div *ngFor="let comment of comments; let i = index" class="mb-3 p-3 bg-light rounded">
          <!-- Comment Header -->
          <div class="d-flex align-items-start mb-2">
            <img [src]="comment.author.profilePicture || 'https://via.placeholder.com/30'" 
                 class="rounded-circle me-2" 
                 style="width: 30px; height: 30px; object-fit: cover;">
            <div class="flex-grow-1">
              <strong>{{comment.author.username}}</strong>
              <small class="text-muted ms-2">{{comment.createdDate | date:'short'}}</small>
            </div>
          </div>
          
          <!-- Comment Content -->
          <div class="mb-2">
            <p class="mb-0" [innerHTML]="formatContent(comment.content)"></p>
          </div>
          
          <!-- Reply Button - Always Visible -->
          <button class="btn btn-outline-primary btn-sm mb-2" (click)="toggleReply(i)">
            <i class="fas fa-reply me-1"></i>Reply
          </button>
          
          <!-- Reply Form -->
          <div *ngIf="comment.showReplyForm" class="mb-2">
            <div class="position-relative">
              <textarea 
                class="form-control form-control-sm mb-2" 
                rows="2" 
                placeholder="Write a reply... Use @username to mention"
                [(ngModel)]="comment.replyText"
                (keyup)="onReplyKeyUp($event, i)"
                (keydown)="onReplyKeyDown($event, i)"></textarea>
              
              <!-- User suggestions dropdown for replies -->
              <div *ngIf="comment.showReplySuggestions && comment.replySuggestions?.length > 0" 
                   class="position-absolute bg-white border rounded shadow-sm" 
                   style="top: 100%; left: 0; right: 0; z-index: 1000; max-height: 150px; overflow-y: auto;">
                <div *ngFor="let user of comment.replySuggestions; let j = index" 
                     class="p-2 border-bottom cursor-pointer hover-bg-light"
                     [class.bg-light]="comment.selectedReplySuggestionIndex === j"
                     (click)="selectReplyUser(user, i)">
                  <strong>@{{user.username}}</strong>
                </div>
              </div>
            </div>
            
            <button class="btn btn-primary btn-sm me-2" 
                    (click)="addReply(i)" 
                    [disabled]="!comment.replyText?.trim()">
              Submit Reply
            </button>
            <button class="btn btn-secondary btn-sm" (click)="cancelReply(i)">
              Cancel
            </button>
          </div>
          
          <!-- Replies -->
          <div *ngIf="comment.replies?.length > 0" class="ms-4">
            <div *ngFor="let reply of comment.replies" class="mb-2 p-2 bg-white rounded border">
              <div class="d-flex align-items-start">
                <img [src]="reply.author.profilePicture || 'https://via.placeholder.com/25'" 
                     class="rounded-circle me-2" 
                     style="width: 25px; height: 25px; object-fit: cover;">
                <div>
                  <strong class="small">{{reply.author.username}}</strong>
                  <small class="text-muted ms-2">{{reply.createdDate | date:'short'}}</small>
                  <p class="mb-0 mt-1 small" [innerHTML]="formatContent(reply.content)"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>